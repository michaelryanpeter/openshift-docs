// Module included in the following assemblies:
// * scalability_and_performance/ztp-image-based-upgrade.adoc

:_mod-docs-content-type: CONCEPT
[id="ztp-image-based-upgrade-guide_{context}"]
= Guidelines for the image-based upgrade

For a successful image-based upgrade, your deployments need to consider certain requirements.

There are different deployment methods in which you can perform the image-based upgrade:

{ztp}:: You utilize the {ztp-first} to deploy and configure your clusters.
Non-GitOps:: You only use {rh-rhacm-first} to deploy and configure your clusters.

[id="ztp-image-based-upgrade-cluster-validated-software_{context}"]
== Minimum software version of components

Depending on your deployment method, the image-based upgrade requires the following minimum software versions.

.Minimum software version of components
[cols=3*, width="80%", options="header"]
|====
|Component
|Software version
|Required

|{lcao}
|4.16
|Yes

|OADP Operator
|1.3.1
|Yes

|Managed cluster version
|4.14.13
|Yes

|Hub cluster version
|4.16
|Yes

|{rh-rhacm}
|2.10.2
|Yes

|{ztp} plugin
|4.16
|Only for {ztp} deployment method

|{gitops-title}
|TBD
|Only for {ztp} deployment method

|{cgu-operator-first}
|4.16
|Only for {ztp} deployment method

|Local Storage Operator ^[1]^
|TBD
|Yes

|{lvms-first} ^[1]^
|4.14.2
|Yes
|====
. The persistent storage must be provided by either the {lvms} or the Local Storage Operator, not both.

[id="ztp-image-based-upgrade-hub-cluster-guide_{context}"]
== Hub cluster guidelines

If you are using {rh-rhacm-first}, your hub cluster needs to meet the following conditions:

* To avoid including any {rh-rhacm} resources in your seed image, you need to disable all optional {rh-rhacm} add-ons for the seed image generation.
* Your hub cluster must be upgraded at least to the target version before performing an image-based upgrade.

[id="ztp-image-based-upgrade-seed-image-guide_{context}"]
== Seed image guidelines

The seed image targets a set of {sno} clusters with similar configuration.
This means that the seed cluster needs to have the same configuration as the target clusters for the following items:

* Performance profile
* `MachineConfig` resources for the target cluster
* IP version
+
[NOTE]
====
Dual-stack networking is not supported in this release.
====

* Set of Day 2 Operators, including the {lcao} and the OADP Operator
* Disconnected registry
* FIPS configuration
* If the target cluster has multiple IPs and one of them belongs to the subnet that was used for creating the seed image, the upgrade fails if the target cluster's node IP does not belong to that subnet.

The following configurations only have to partially match on the participating clusters:

* If the target cluster has a proxy configuration, the seed cluster must have a proxy configuration too but the configuration does not have to be the same.
* A dedicated partition on the primary disk for container storage is required on all participating clusters. However, the size and start of the partition does not have to be the same. Only the `spec.config.storage.disks.partitions.label: varlibcontainers` label in the `MachineConfig` CR must match on both the seed and target clusters.

For more information about what to include in the seed image, see _Seed image configuration_ and _Seed image configuration using the RAN DU profile_.

[id="ztp-image-based-upgrade-extra-manifests-guide_{context}"]
== Extra manifest guidelines

The {lcao} uses extra manifests to restore your target clusters after rebooting with the new default stateroot deployment and before restoring application artifacts.

Different deployment methods require a different way to apply the extra manifests:

{ztp}:: You use the `target-ocp-version: <target_ocp_version>` label to mark the extra manifests that the {lcao} must extract and apply after the pivot.
Non-Gitops:: You mark your extra manifests with the `lca.openshift.io/apply-wave` annotation to determine the apply order. The labelled extra manifests are wrapped in `ConfigMap` objects and referenced in the `ImageBasedUpgrade` CR that the {lcao} uses after the pivot.

If the target cluster uses custom catalog sources, you must include them as extra manifests that points to the correct release version.

[IMPORTANT]
====
You cannot apply the following items as extra manifests:

* `MachineConfig` objects
* OLM Operator subscriptions
====

[id="ztp-image-based-upgrade-backup-guide_{context}"]
== OADP backup and restore guidelines

With the OADP Operator, you can back up and restore your applications on your target clusters.
The application must work on the current and the target {product-title} versions so they can be restored after the upgrade.
The backups must include resources that were initially created.
//by what?

The following resources must be excluded from the backup:

* `pods`
* `endpoints`
* `controllerrevision`
* `podmetrics`
* `packagemanifest`
* `replicaset`
* `localvolume`, if using persistent volumes

For the image-based upgrade, only one local storage Operator is supported on a given cluster. You have two options to back up and restore your local storage:

Local Storage Operator (LSO):: The {lcao} backs up and restores the required artifacts. You must exclude the `persistentVolumes` resource in the application `Backup` CR.

{lvms}:: You must create the `Backup` and `Restore` CRs for {lvms}.

[IMPORTANT]
====
For both Operators, you must not apply the Operator CRs as extra manifests through the `ImageBasedUpgrade` CR.
====

The persistent volume contents are preserved and used after the pivot.
When you are configuring the `DataProtectionApplication` CR, you must ensure that the `.spec.configuration.restic.enable` is set to `false` for an image-based upgrade.
This disables Container Storage Interface integration.

You must create separate `Backup` and `Restore` CRs to scope the backup to the cluster-scoped resources created by the application. 
The `Restore` CR for the cluster-scoped resources must be restored before the remaining application `Restore` CR(s).
Use the `lca.openshift.io/apply-wave` annotation to determine the apply order of `Restore` CRs.